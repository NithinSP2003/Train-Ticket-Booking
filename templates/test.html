<!DOCTYPE html>
<html>
<head>
    <title>Train Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/train-list.css">
</head>
<body>
    <div class="container" style="max-width: 100% !important; padding: 0%;">
        <div class="row">
            <div class="col-md-2">
                <div class="sidebar">
                    <!-- Sidebar content unchanged -->
                </div>
            </div>

            <div class="col-md-10">
                <div class="container" style="width: 90%;">
                    <h3 class="mb-4 text-center" style="margin-top: 4%;">
                        Trains from {{ from_station }} to {{ to_station }} 
                    </h3>

                    <!-- Filter Section -->
                    <div class="filter-section mb-4">
                        <form method="GET" action="{{ url_for('train_results') }}">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="from_station" class="form-label">From Station</label>
                                    <select class="form-select" id="from_station" name="from_station">
                                        <!-- Example static options, replace with dynamic values -->
                                        <option value="station1">Station 1</option>
                                        <option value="station2">Station 2</option>
                                        <option value="station3">Station 3</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="to_station" class="form-label">To Station</label>
                                    <select class="form-select" id="to_station" name="to_station">
                                        <!-- Example static options, replace with dynamic values -->
                                        <option value="station1">Station 1</option>
                                        <option value="station2">Station 2</option>
                                        <option value="station3">Station 3</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="class_type" class="form-label">Class Type</label>
                                    <select class="form-select" id="class_type" name="class_type">
                                        <!-- Example static options, replace with dynamic values -->
                                        <option value="AC">AC</option>
                                        <option value="Sleeper">Sleeper</option>
                                        <option value="Second Class">Second Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-primary">Filter</button>
                            </div>
                        </form>
                    </div>

                    {% if trains %}
                        {% for train in trains %}
                            <div class="card shadow-sm border-start border-4 border-primary rounded-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="card-title"><strong>{{ train.name }}</strong> ({{ train.number }})</h5>
                                        <span class="text-muted">Runs On: {{ train.run_days or 'Daily' }}</span>
                                    </div>

                                    <div class="row align-items-center text-center mt-2">
                                        <div class="col-md-4">
                                            <h5 class="text-primary mb-0">{{ train.departure_time }}</h5>
                                            <small class="text-muted">{{ from_station.title() }} | {{ train.journey_date or 'Today' }}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="time-line"><span>{{ train.duration or 'â€”:â€”' }}</span></div>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-success mb-0">{{ train.arrival_time }}</h5>
                                            <small class="text-muted">{{ to_station.title() }} | {{ train.arrival_date or 'Today' }}</small>
                                        </div>
                                    </div>

                                    <div class="mt-4 d-flex gap-2 align-items-center">
                                        <span class="text-dark fw-bold me-2">Available Classes:</span>
                                        {% for cls in train.classes.split(',') %}
                                            {% set class_code = cls | trim %}
                                            <button class="btn btn-outline-secondary btn-sm class-btn"
                                                    onclick="loadAvailability('{{ train.number }}','{{ from_station }}','{{ to_station }}', '{{ class_code }}', 'info-{{ train.number }}')">
                                                {{ class_labels.get(class_code, class_code) }}
                                            </button>
                                        {% endfor %}
                                    </div>

                                    <div class="mt-3" id="info-{{ train.number }}"></div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning text-center">ðŸš« No trains found for the selected route and class.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

<script>
    function loadAvailability(trainNumber, from, to, classCode, targetId) {
        fetch(`/get_availability?train_number=${trainNumber}&class_code=${classCode}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(targetId);
                container.innerHTML = '';

                if (!data.length) {
                    container.innerHTML = '<div class="text-danger">No data available for this class.</div>';
                    return;
                }

                let html = '<div class="mt-2">';
                html += `<h6>Availability for ${classCode}:</h6>`;
                html += '<div class="d-flex gap-3" id="availability-cards">';

                data.forEach(item => {
                    const date = item.date;
                    const availabilityStatus = item.availability;

                    html += `
                        <div class="card p-2 selectable-card text-center"
                            style="min-width: 20%; max-width: 25%; cursor: pointer;"
                            data-train="${trainNumber}"
                            data-class="${classCode}"
                            data-date="${date}"
                            data-availability="${availabilityStatus}">
                            <div><strong>${date}</strong></div>
                            <div>${availabilityStatus}</div>
                        </div>`;
                });

                html += '</div></div>';
                container.innerHTML = html;

                let selectedCard = null;
                const cards = container.querySelectorAll('.selectable-card');

                cards.forEach(card => {
                    card.addEventListener('click', () => {
                        if (selectedCard) {
                            selectedCard.classList.remove('border-success', 'border-2');
                        }
                        selectedCard = card;
                        card.classList.add('border-success', 'border-2');

                        const train = card.getAttribute('data-train');
                        const cls = card.getAttribute('data-class');
                        const date = card.getAttribute('data-date');
                        const wl = card.getAttribute('data-availability');

                        showBookingButton(container, train, cls, date, wl, from, to);
                    });
                });
            })
            .catch(error => {
                document.getElementById(targetId).innerHTML = `<div class="text-danger">Error loading data.</div>`;
                console.error('Error fetching availability:', error);
            });
    }

    function showBookingButton(container, train, cls, date, wl, from, to) {
        // This function remains unchanged
    }

    function bookNow(train, cls, date, wlText) {
        // This function remains unchanged
    }
</script>
</body>
</html>
