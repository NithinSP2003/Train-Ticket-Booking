<!DOCTYPE html>
<html>
<head>
    <title>Train Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/train-list.css">

</head>
<body>
    <div class="container" style="max-width: 100% !important; padding: 0%;">
        <div class="row">
            <div class="col-md-2">
                <div class="sidebar">
                    <div style="    height: 15%;">
                    <img src="../static/images/ChatGPT Image Apr 23, 2025, 02_24_07 PM.png" alt="Logo 1" style="margin-top: -7%; margin-left: 21%; height: 100%;">
                    </div>        
                    <div class="login-container" style="margin-left: 21%; margin-top: 5%;">
                        <span class="logo-text">
                            <a href="{{ url_for('login_user') }}" class="login-btn" style="text-decoration: none;">Login/Signup</a>
            
                            <p id="timestamp"></p>
                        </span>
                    </div>
                    <div class="logo-container">
                        <img src="../static/icons/home.svg" alt="Logo 1" class="logo-img">
                        <span class="logo-text">
                            <a href="{{ url_for('index') }}">Home</a></span>
                    </div>
                    <div class="logo-container">
                        <img src="../static/icons/transit_ticket.svg" alt="Logo 2" class="logo-img">
                        <span class="logo-text">
                            <a href="{{ url_for('index') }}">PNR Enquiry</a></span>        
                    </div>
                    <div class="logo-container">
                        <img src="../static/icons/cancel-ticket.png" alt="Logo 3" class="logo-img">
                        <span class="logo-text">
                            <a href="{{ url_for('index') }}">Ticket Cancelation</a></span>        
                    </div>
                </div>
                <div id="login-status" data-logged-in="{{ session.get('user_logged_in', False) }}"></div>

            </div>
            <div class="col-md-10">
                <div class="container" style="width: 90%;">
                <h3 class="mb-4 text-center" style="margin-top: 4%;">
                    Trains from {{ from_station }} to {{ to_station }} 
                    [Class: {{ class_labels.get(class_type, class_type) }}]
                </h3>

                {% if trains %}
                    {% for train in trains %}
                        <div class="card shadow-sm border-start border-4 border-primary rounded-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title">
                                        <strong>{{ train.name }}</strong> ({{ train.number }})
                                    </h5>
                                </div>

                                <div class="row align-items-center text-center mt-2">
                                    <div class="col-md-4">
                                        <h5 class="text-primary mb-0">{{ train.departure_time }}</h5>
                                        <small class="text-muted">{{ from_station.title() }} | {{ train.journey_date or 'Today' }}</small>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="time-line">
                                            <span>{{ train.duration or 'â€”:â€”' }}</span>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <h5 class="text-success mb-0">{{ train.arrival_time }}</h5>
                                        <small class="text-muted">{{ to_station.title() }} | {{ train.journey_date or 'Today' }}</small>
                                    </div>
                                </div>

                                <div class="mt-4 d-flex gap-2 align-items-center">
                                    <span class="text-dark fw-bold me-2">Available Classes:</span>
                                    {% for cls in train.classes.split(',') %}
                                        {% set class_code = cls | trim %}
                                        <button class="btn btn-outline-secondary btn-sm class-btn"
                                                onclick="loadAvailability('{{ train.number }}','{{ from_station }}','{{ to_station }}', '{{ class_code }}', 'info-{{ train.number }}')">
                                            {{ class_labels.get(class_code, class_code) }}
                                        </button>
                                    {% endfor %}

                                </div>

                                <div class="mt-3" id="info-{{ train.number }}"></div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning text-center">
                        ðŸš« No trains found for the selected route and class.
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>

<script>
    function loadAvailability(trainNumber, from,to,classCode, targetId) {
        fetch(`/get_availability?train_number=${trainNumber}&class_code=${classCode}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(targetId);
                container.innerHTML = ''; // clear previous content

                if (!data.length) {
                    container.innerHTML = '<div class="text-danger">No data available for this class.</div>';
                    return;
                }

                let html = '<div class="mt-2">';
                html += `<h6>Availability for ${classCode}:</h6>`;
                html += '<div class="d-flex gap-3" id="availability-cards">';

                data.forEach(item => {
                    let availabilityStatus = item.availability;
                    const date = item.date;

                    html += `
                        <div class="card p-2 selectable-card text-center"
                            style="min-width: 20%; max-width: 25%; cursor: pointer;"
                            data-train="${trainNumber}"
                            data-class="${classCode}"
                            data-date="${date}"
                            data-availability="${availabilityStatus}">
                            <div><strong>${date}</strong></div>
                            <div>${availabilityStatus}</div>
                        </div>`;
                });

                html += '</div></div>';
                container.innerHTML = html;

                let selectedCard = null;

                const cards = container.querySelectorAll('.selectable-card');
                cards.forEach(card => {
                    card.addEventListener('click', () => {
                        // Deselect previous card
                        if (selectedCard) {
                            selectedCard.classList.remove('border-success', 'border-2');
                        }

                        // Select new card
                        selectedCard = card;
                        card.classList.add('border-success', 'border-2');

                        const train = card.getAttribute('data-train');
                        const cls = card.getAttribute('data-class');
                        const date = card.getAttribute('data-date');
                        const wl = card.getAttribute('data-wl');

                        showBookingButton(container, train, cls, date, wl,from, to);
                    });
                });
            })
            .catch(error => {
                document.getElementById(targetId).innerHTML = `<div class="text-danger">Error loading data.</div>`;
                console.error('Error fetching availability:', error);
            });
    }

    function showBookingButton(container, train, cls, date, wl, from, to) {
    const existingBtn = container.querySelector('.booking-button');
    if (existingBtn) existingBtn.remove();

    const btnHtml = `
        <div class="row" style="justify-content: flex-end;">
            <div class="col-md-4 text-end"></div>
            <div class="col-md-3">
                <p class="fare-btn" id="fare">Calculating fare...</p>
            </div>
            <div class="col-md-3">
                <button class="btn btn-warning" onclick="bookNow('${train}', '${cls}', '${date}', '${wl}')">
                    Book for ${date}
                </button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', btnHtml);

    // Now that #fare is in the DOM, we can safely update it
    fetch('/cal_fare', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            trainNumber: train,
            from: from,
            to: to,
            classCode: cls
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Fare response:', data);
        if (data && data.fare !== undefined && data.fare !== null) {
            document.getElementById('fare').innerText = `â‚¹${data.fare}`;
        } else {
            document.getElementById('fare').innerText = 'Fare not available';
        }
    })
    .catch(error => {
        console.error('Error fetching fare:', error);
        document.getElementById('fare').innerText = 'Error fetching fare';
    });
}


    
    function bookNow(train, cls, date, wlText) {
    // Extract status type: 'available', 'rac', 'wl'
    let status = wlText.toLowerCase().split(':')[0].trim();
 
    // If Available: 0 â†’ check fallback to RAC or WL
    let count = parseInt(wlText.split(':')[1]?.trim()) || 0;
    if (status === 'available' && count === 0) {
        if (wlText.includes('RAC')) {
            status = 'rac';
        } else if (wlText.includes('WL')) {
            status = 'wl';
        }
    }
 
    const url = `/book?train=${train}&class=${cls}&date=${encodeURIComponent(date)}&status=${encodeURIComponent(status)}`;
    window.location.href = url;
}

    function validateSearchForm() {
        // âœ… Get login status safely from HTML
        const isLoggedIn = document.getElementById("login-status").dataset.loggedIn === "True";
        if (!isLoggedIn) {
            alert("Please login to search for buses.");
            window.location.href = "{{ url_for('login_user') }}";
            return false;
        }
        return true;
    }

</script>


</body>
</html>
